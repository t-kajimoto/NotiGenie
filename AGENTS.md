# AGENTS.md

このファイルは、AIエージェント（Julesなど）がNotiGenieプロジェクトを理解し、開発・テストを行うための包括的な行動指針とガイドラインです。

## 1. プロジェクト概要とコンセプト

*   **概要**: NotiGenieは、Raspberry Pi上で動作し、Cloud Functions上のバックエンドを経由してNotionを操作する音声AIアシスタントです。
*   **コンセプト**: "呼びかけるだけであらゆる情報整理やタスク管理を正確にこなしてくれる賢いアシスタント"。すべての提案や実装がこのコンセプトに沿うように努めます。
*   **ゴール**: 開発者と共に、Raspberry Pi, Python, Gemini API, Cloud Functions, Dockerなどの技術スタックを習得し、メンテナンス性の高いアプリケーションを完成させること。

## 2. 行動指針と開発スタイル

### AI駆動開発の実践
*   **提案駆動**: 指示待ちにならず、ロードマップや要件を意識し、タスク・実装方法・テストケース・改善案を積極的に提案してください。
*   **ドキュメントファースト**: 実装に着手する前に、必ずMarkdown形式の設計書を確認・作成してください。`docs/design` などを参照し、認識の齟齬を防ぎます。
*   **対話と確認**: 開発者の意図を正確に汲み取るため、不明瞭な点は質問し、認識を合わせてからタスクを実行してください。

### 言語 (Language)
*   **最重要ルール**: AIエージェントとユーザーとの対話（チャット、プラン説明）、およびGitのコミットメッセージ、Pull Requestのタイトル・説明・コメントは、**必ず日本語**を使用してください。
*   英語の使用は、コード内の変数名や、引用が必要なエラーメッセージ、公式ドキュメントの参照などに限定してください。

## 3. アーキテクチャと設計思想

詳細は `docs/architecture.md` を参照してください。

### クリーンアーキテクチャ (Clean Architecture)
本プロジェクト（特に `cloud_functions/`）は、クリーンアーキテクチャの原則に基づいています。変更を加える際は、以下のレイヤー構成を維持してください。

*   **関心の分離**: Entities, Use Cases, Interfaces, Infrastructure の各層の責務を明確に分離します。
*   **依存性のルール**: 内側の層（Domain/Use Cases）は、外側の層（Infrastructure/Frameworks）について一切関知しないように設計します。
*   **交換可能性**: AIモデルや外部サービスが容易に交換・追加できるよう、インターフェースを介した疎結合な実装を徹底します。

### 構成要素
*   **Cloud Functions (`cloud_functions/`)**: バックエンドロジック (Geminiによる意図解析、Notion操作)。
    *   `core/domain`: インターフェース定義。
    *   `core/use_cases`: ビジネスロジック。
    *   `core/interfaces/gateways`: 外部サービスへのアダプター。
    *   `main.py`: エントリーポイント。Dependency Injectionを行う。
*   **Raspberry Pi (`raspberry_pi/`)**: クライアント (音声入出力、STT、TTS)。

## 4. 技術スタックとコーディング規約

*   **Python**: 型ヒントを積極的に活用し、PEP 8に準拠した可読性の高いコードを作成してください。
*   **コメント**:
    *   **Docstrings**: クラス・メソッドの役割、引数、戻り値を明確に記述する。
    *   **Inline Comments**: 「なぜそうするのか（Why）」、「何をしているのか（What）」を丁寧に説明する。特にアーキテクチャ上の意図や非同期処理については詳しく記述する。
*   **Linter**: `flake8` を使用して構文チェックを行ってください。
*   **ファイル構成**:
    *   `cloud_functions/`: バックエンドコード。
    *   `raspberry_pi/`: クライアントコード。
    *   `tests/`: テストコード。
    *   `docs/`: ドキュメント。

## 5. 環境構築とテスト実行

### 依存関係のインストール
テストに必要なライブラリをインストールします。

```bash
pip install -r cloud_functions/requirements.txt
# テスト用
pip install pytest pytest-asyncio pytest-mock
```

### 設定ファイルの準備
`.env` (または環境変数) でAPIキーを設定します（テスト時はダミーで可）。

```bash
export GEMINI_API_KEY="dummy"
export NOTION_API_KEY="dummy"
```

### テストの実行とルール
*   **実行コマンド**: `pytest tests/`
*   **テスト駆動**: 新しいロジックや機能を実装する際は、必ず`pytest`をフレームワークとしたテストコードの作成を同時に行い、品質を担保してください。
*   **高品質なテストケース**: リリースの質を高めるため、テストケースは極力細かく作成してください。正常系だけでなく、異常系や境界値なども網羅することを目標とします。
*   **PR提出前の確認**: PRを出す（または作業を完了として提出する）前に、必ず修正した部分に関するテストを実行し、エラーなく成功することを確認してください。
*   **モックの活用**: Raspberry Piのハードウェア依存部分や外部API呼び出しは、`unittest.mock` や `pytest-mock` を活用してテストしてください。

## 6. 具体的なタスク遂行ルールと注意点

*   **セキュリティ**: APIキーやトークンなどのシークレット情報は、`.env`ファイルと環境変数を組み合わせた方法で管理し、ソースコードやDockerfileへのハードコードは厳禁です。
*   **Git運用**:
    *   コミットメッセージ、PR等は日本語で記述してください。
    *   **重要**: コミットメッセージ内では `#` 記号を使用しないでください。シェルのコマンド置換を引き起こし、ツール実行エラーの原因となります。
*   **過去の教訓**:
    *   **ドキュメントファーストの徹底**: 設計書がないまま実装を進め、手戻りが発生しないようにする。
    *   **インポート規約**: `cloud_functions` ディレクトリ等をルートと見なした絶対インポートを使用すること（相対インポートや `src.` プレフィックスの誤用に注意）。
    *   **Docker/環境**: ライブラリ不足（`build-essential`, `portaudio` 等）に注意。要件変更時はイメージの再ビルドを忘れないこと。
