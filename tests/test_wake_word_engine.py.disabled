import sys
from unittest.mock import MagicMock, patch

# Mock external hardware libraries before importing the module
sys.modules["pvporcupine"] = MagicMock()
sys.modules["pvrecorder"] = MagicMock()

import pytest
from raspberry_pi.wake_word_engine import WakeWordEngine

# We need to patch the imported names in the module scope
# Since we mocked sys.modules['pvporcupine'], the import in wake_word_engine
# assigned that Mock object to the name 'pvporcupine'.
# We can configure that object directly.

@pytest.fixture
def mock_pvporcupine():
    # Configure the mock that is already in use by the module
    mock_module = sys.modules["pvporcupine"]
    mock_module.reset_mock() # Reset all calls
    mock_module.create.reset_mock() # Reset specific method calls
    mock_module.create.return_value = MagicMock()
    mock_module.create.return_value.frame_length = 512
    return mock_module

@pytest.fixture
def mock_pvrecorder():
    mock_module = sys.modules["pvrecorder"]
    mock_module.reset_mock()
    # The module has a PvRecorder class (mocked)
    # The code calls PvRecorder(...) -> instance
    mock_module.PvRecorder.return_value = MagicMock()
    return mock_module.PvRecorder

class TestWakeWordEngine:
    def test_init_defaults(self, mock_pvporcupine, mock_pvrecorder):
        access_key = "test_key"
        engine = WakeWordEngine(access_key)

        mock_pvporcupine.create.assert_called_once_with(access_key=access_key)
        mock_pvrecorder.assert_called_once()
        assert engine.porcupine is not None
        assert engine.recorder is not None

    def test_init_with_keyword_paths(self, mock_pvporcupine, mock_pvrecorder):
        access_key = "test_key"
        paths = ["/path/to/genie.ppn"]
        engine = WakeWordEngine(access_key, keyword_paths=paths)

        mock_pvporcupine.create.assert_called_once_with(
            access_key=access_key,
            keyword_paths=paths,
            model_path=None,
            sensitivities=[0.5]
        )

    def test_wait_for_wake_word(self, mock_pvporcupine, mock_pvrecorder):
        engine = WakeWordEngine("test_key")

        # mock_pvrecorder is the Class (mock), we need the instance it returned
        recorder_instance = engine.recorder

        # Mocking the interaction:
        # Loop 1: process returns -1 (no wake word)
        # Loop 2: process returns 0 (wake word detected at index 0)
        engine.porcupine.process.side_effect = [-1, 0]
        recorder_instance.read.return_value = [0] * 512 # Dummy PCM data

        # Calling the method
        result = engine.wait_for_wake_word()

        # Assertions
        assert result == 0
        assert recorder_instance.start.call_count == 1
        # It should have called process twice
        assert engine.porcupine.process.call_count == 2
        # It should have stopped recording
        assert recorder_instance.stop.call_count == 1

    def test_cleanup(self, mock_pvporcupine, mock_pvrecorder):
        engine = WakeWordEngine("test_key")
        engine.porcupine = MagicMock()
        engine.recorder = MagicMock()

        engine.cleanup()

        engine.porcupine.delete.assert_called_once()
        engine.recorder.delete.assert_called_once()
