
# Notionデータベース監視・通知機能 設計書

## 1. 概要

本ドキュメントは、GitHub Issue #6「Notionデータベースのページを定期的にチェックし、特定の条件を満たすページを通知する機能の実装」で定義された要件を実現するための設計を記述する。

## 2. 目的

Notionで管理されているタスクや情報の更新を見逃さないように、指定した条件に合致するページを検出し、ユーザーに通知する仕組みを構築する。

## 3. アーキテクチャ

本機能は、`GEMINI.md`で定義されたクリーンアーキテクチャの原則に則り、以下のコンポーネントで構成される。

- **Frameworks & Drivers (最外層):**
    - **スケジューラ:** 定期実行のトリガー (例: `apscheduler`ライブラリ)
    - **NotionMCP (`mcp-notion`):** Notion APIとの通信を担う外部サービスアダプタ
    - **通知サービスアダプタ:** LINEやメールなど、外部通知サービスとの連携
    - **設定ローダー:** `.env`ファイルからAPIキーやデータベースIDを読み込む

- **Interface Adapters (中間層):**
    - **コントローラ:** スケジューラからの要求を受け、ユースケースを呼び出す
    - **Notionゲートウェイ:** `mcp-notion`をラップし、ユースケース層が要求する形式でデータを提供するインターフェース

- **Use Cases (ビジネスロジック層):**
    - **ページ監視ユースケース:** Notionゲートウェイを介してページを取得し、フィルタリング条件に基づき、通知すべきページを特定するビジネスロジック

- **Entities (最内層):**
    - **Notionページ:** Notionページの構造を表すデータ構造
    - **フィルタ条件:** 「ステータスが未着手」「期限が3日以内」といった条件を表すデータ構造

依存性のルールに従い、内側の層は外側の層に依存しない。

## 4. コンポーネント詳細と実装方針

### 4.1. Notionデータ取得 (`mcp-notion`の利用)

- `test_notion_connection.py`で示されている通り、`mcp-notion`サーバーをサブプロセスとして起動し、`mcp`ライブラリを介して通信する。
- Notionデータベースの内容を取得するため、`mcp-notion`が提供する`query_database`ツール（または同等の機能を持つツール）を利用する。
- フィルタリングは、`mcp-notion`のフィルタ機能を利用するか、一旦全データを取得した後にPython側で処理するかを、`mcp-notion`の仕様を調査した上で決定する。

### 4.2. フィルタリングロジック

- ユースケース層に、フィルタリングロジックを実装する。
- フィルタ条件は、設定ファイルや環境変数から読み込み、動的に変更可能にする。
    - 例: `FILTER_PROPERTY_NAME=ステータス`
    - `FILTER_PROPERTY_VALUE=未着手`
    - `FILTER_DATE_PROPERTY_NAME=期限`
    - `FILTER_DATE_WITHIN_DAYS=3`

### 4.3. 通知機能

- 通知部分はインターフェースを定義し、具体的な通知手段（LINE, Email等）を容易に差し替えられるように設計する。
- まずは、コンソールに整形して出力するだけのシンプルな通知機能を実装する。

### 4.4. 定期実行

- `apscheduler`などの軽量なスケジューリングライブラリを導入し、指定した間隔（例: 1日1回）でページ監視ユースケースを実行する。

## 5. データフロー

1. **スケジューラ**が指定時刻に**コントローラ**を呼び出す。
2. **コントローラ**が**ページ監視ユースケース**をトリガーする。
3. **ページ監視ユースケース**が**Notionゲートウェイ**にページ取得を要求する。
4. **Notionゲートウェイ**が**`mcp-notion`サーバー**の`query_database`ツールを呼び出す。
5. **`mcp-notion`**がNotion APIを叩き、データベースのページを取得して返す。
6. **Notionゲートウェイ**が取得結果を**ユースケース**が扱いやすい形式に変換して渡す。
7. **ページ監視ユースケース**が、受け取ったページリストを**フィルタ条件**に基づき絞り込む。
8. **ページ監視ユースケース**が、条件に合致したページ情報を**通知サービスアダプタ**に渡す。
9. **通知サービスアダプタ**が、指定された方法（当面はコンソール出力）でユーザーに通知する。

## 6. 設定項目

以下の情報を`.env`ファイルで管理する。

- `NOTION_API_KEY`: NotionインテグレーションのAPIキー
- `NOTION_DATABASE_ID`: 監視対象のデータベースID
- (フィルタリング条件に関する変数は4.2.参照)
- (通知先に関する変数は将来的に追加)

