
# クリーンアーキテクチャ設計書

## 1. 概要

本ドキュメントは、NotiGenieアプリケーションの基本構造となるクリーンアーキテクチャに基づいたディレクトリ構造と、主要なクラスのひな形について設計する。
この設計は、開発ロードマップのタスク「[P1-1.2.1] クリーンアーキテクチャに基づいたディレクトリ構造と、主要なクラスのひな形を作成」に対応する。

## 2. 目的

メンテナンス性、テスト容易性、交換可能性の高いソフトウェア構造を確立する。
関心事を分離し、ビジネスロジック（ドメイン）をフレームワークやUI、DBなどの技術的詳細から独立させる。

## 3. ディレクトリ構造

`src`ディレクトリ配下を、クリーンアーキテクチャの各層に対応する形で構成する。

```
src/
├── adapter/                # 変換層: 内外のデータを変換するアダプタ
│   ├── controllers/        # 入力変換: UIやCLIからの入力をユースケースが分かる形式に
│   ├── gateways/           # 出力変換: DBや外部APIとの通信を抽象化
│   └── presenters/         # 出力変換: ユースケースの結果をUIが表示できる形式に
├── domain/                 # 中心層: アプリケーションの核となるビジネスロジック
│   ├── entities/           # ビジネスオブジェクトの定義
│   └── use_cases/          # アプリケーション固有のビジネスルール
├── frameworks/             # 最外層: フレームワークやドライバ（具体的な実装）
│   └── hardware/           # (既存)ハードウェア操作の実装
├── main.py                 # アプリケーションのエントリポイント、依存関係の注入
└── poc/                    # (既存)技術検証用のスクリプト置き場
```

## 4. 各層の責務とクラス設計

### 4.1. Domain Layer (ドメイン層)

アプリケーションの最も中心的な部分。他のどの層にも依存しない。

- **`domain/entities/`**: ビジネスの核となるデータ構造やオブジェクトを定義する。
    - `audio.py`: 音声データのエンティティ。データ本体やサンプリングレートを持つ。
    - `transcription.py`: 文字起こし結果のエンティティ。テキスト本体や信頼度を持つ。

- **`domain/use_cases/`**: アプリケーションの具体的なユースケース（やりたいこと）を実装する。
    - `record_and_transcribe.py`: 「録音して文字起こしする」という一連の流れを実装する。オーディオ録音と文字起こしのためのインターフェース（ポート）を定義し、それに依存する。

### 4.2. Adapter Layer (アダプター層)

ドメイン層とフレームワーク層の間のデータ変換を担う。

- **`adapter/gateways/`**: ドメイン層が定義したインターフェース（ポート）を実装し、外部システム（DB、API、ハードウェア）との通信を抽象化する。
    - `audio_recorder_gateway.py`: `domain.use_cases`が要求する録音インターフェースを実装。内部で`frameworks.hardware.AudioRecorder`を呼び出す。
    - `speech_to_text_gateway.py`: `domain.use_cases`が要求する文字起こしインターフェースを実装。内部でGoogle Cloud Speech-to-Text APIを呼び出す。

- **`adapter/controllers/`**: 外部からの入力（UI、CLI、ボタン押下など）を解釈し、対応するユースケースを呼び出す。
    - `main_controller.py`: `ButtonHandler`からのコールバックを受け取り、`RecordAndTranscribe`ユースケースを実行するトリガーとなる。

- **`adapter/presenters/`**: ユースケースの実行結果を、外部システム（UIなど）が表示しやすい形式に変換する。（今回は主にコンソール出力）

### 4.3. Frameworks & Drivers Layer (フレームワーク＆ドライバ層)

最も外側の層。フレームワーク、ライブラリ、ハードウェアなどの具体的な実装を配置する。

- **`frameworks/hardware/`**: (既存の`src/hardware`をここに位置づける)
    - `button_handler.py`: `RPi.GPIO`を使った物理ボタン操作の実装。
    - `audio_recorder.py`: `sounddevice`を使ったマイク録音の実装。

## 5. 依存性のルール

- **内側に向かって依存:** 外側の層は内側の層を知っているが、内側の層は外側の層を知らない。
    - 例: `adapter`層は`domain`層を知っているが、`domain`層は`adapter`層を知らない。
- **依存性逆転の法則:** `domain.use_cases`は具体的な実装（Gateway）に依存せず、インターフェース（抽象）に依存する。具体的な実装は`main.py`で注入（DI: Dependency Injection）する。
